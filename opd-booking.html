<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPD Booking | Bhakti Lok Hospital</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Styles for Dynamic Slots */
        .slot-btn.booked {
            background-color: #e0e0e0;
            color: #999;
            border-color: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }
        /* Highlight selected slot */
        .slot-btn.selected {
            background-color: var(--primary-blue);
            color: white;
            border-color: var(--primary-blue);
            transform: scale(1.05);
        }
        .slot-loader {
            text-align: center;
            color: var(--primary-blue);
            font-weight: bold;
            padding: 10px;
        }
    </style>
</head>
<body>

    <div class="top-bar">
        <div class="container top-bar-content">
            <div class="top-contact">
                <span><i class="fas fa-phone-alt"></i> Help: <strong>077380 40157</strong></span>
            </div>
            <div class="top-socials">
                <a href="index.html" style="color:white; font-size:0.9rem;"><i class="fas fa-arrow-left"></i> Back to Home</a>
            </div>
        </div>
    </div>

    <section class="opd-section section-padding" id="booking-interface">
        <div class="container">
            <div class="opd-grid">
                
                <div class="opd-instructions">
                    <h3 class="section-heading">Important Guidelines</h3>
                    <div class="blue-line"></div>
                    <p style="margin-bottom: 20px;">Please read the following instructions carefully before booking your appointment:</p>
                    
                    <ul class="guidelines-list">
                        <li>
                            <i class="fas fa-clock"></i> 
                            <strong>Reporting Time:</strong> Please arrive at the reception at least 15 minutes prior to your scheduled slot for vital checks.
                        </li>
                        <li>
                            <i class="fas fa-id-card"></i> 
                            <strong>Identity Proof:</strong> It is mandatory to carry a valid government ID (Aadhar Card / Pan Card) for registration.
                        </li>
                        <li>
                            <i class="fas fa-folder-open"></i> 
                            <strong>Medical Records:</strong> Please bring all your previous medical reports, prescriptions, and X-rays for a better diagnosis.
                        </li>
                        <li>
                            <i class="fas fa-mask"></i> 
                            <strong>Safety Protocols:</strong> Wearing a mask is compulsory in the waiting area. Please sanitize your hands upon entry.
                        </li>
                        <li>
                            <i class="fas fa-mobile-alt"></i> 
                            <strong>Mobile Phones:</strong> Keep your mobile phone on silent mode inside the doctor's cabin to avoid disturbances.
                        </li>
                        <li>
                            <i class="fas fa-user-plus"></i> 
                            <strong>Attendants:</strong> Only one attendant is allowed to accompany the patient inside the consultation room.
                        </li>
                    </ul>

                    <div class="process-flow">
                        <h4><i class="fas fa-route"></i> Booking Steps:</h4>
                        <div class="step-item"><span class="step-num">1</span> <span>Fill Health Details</span></div>
                        <div class="step-item"><span class="step-num">2</span> <span>Choose Doctor</span></div>
                        <div class="step-item"><span class="step-num">3</span> <span>Pay & Confirm</span></div>
                    </div>

                    <div class="opd-contact-box">
                        <i class="fas fa-headset"></i>
                        <div>
                            <h5>Need Help Booking?</h5>
                            <p>Call Reception: <strong>077380 40157</strong></p>
                        </div>
                    </div>
                </div>

                <div class="opd-form-card extra-padding">
                    
                    <div id="step1-form">
                        <div class="form-header">
                            <h3>Step 1: Patient Details</h3>
                            <p>Tell us about your health condition</p>
                        </div>
                        <form id="detailsForm" onsubmit="goToStep2(event)" style="padding: 20px 40px;">
                            <div class="form-group">
                                <label>Patient Name *</label>
                                <input type="text" id="pName" class="input-padded" placeholder="Enter Full Name" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Phone Number *</label>
                                    <input type="tel" id="pPhone" class="input-padded" placeholder="10-digit Mobile" required>
                                </div>
                                <div class="form-group">
                                    <label>Age *</label>
                                    <input type="number" id="pAge" class="input-padded" placeholder="Years" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>Current Symptoms (Chief Complaint) *</label>
                                <textarea id="pSym" class="input-padded" placeholder="E.g., High fever since 2 days, stomach pain..." rows="2" required></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>Current Medications</label>
                                <textarea id="pMeds" class="input-padded" placeholder="List any medicines you are currently taking..." rows="2"></textarea>
                            </div>

                            <div class="form-group">
                                <label>Past Medical History</label>
                                <textarea id="pHist" class="input-padded" placeholder="E.g., Diabetes, Hypertension, Previous Surgeries..." rows="2"></textarea>
                            </div>

                            <button type="submit" class="btn-full">Next: Select Doctor <i class="fas fa-arrow-right"></i></button>
                        </form>
                    </div>

                    <div id="step2-doctors" style="display: none;">
                        <div class="form-header">
                            <h3>Step 2: Choose Specialist</h3>
                            <p>Select a doctor to view profile</p>
                        </div>
                        <div style="padding: 30px;">
                            <div class="doctor-selection-grid" id="dynamicDoctorGrid">
                                <p style="text-align:center; color:#666;">Loading Doctors from Database...</p>
                            </div>
                            <button onclick="goBack('step2-doctors', 'step1-form')" class="btn-text">Back</button>
                        </div>
                    </div>

                    <div id="step3-profile" style="display: none;">
                        <div class="form-header">
                            <h3>Doctor Profile</h3>
                            <p>View details and schedule</p>
                        </div>
                        <div style="padding: 30px;">
                            
                            <div class="full-doc-profile">
                                <img id="prof-img" src="images/reception.png" class="prof-img-large" onerror="this.src='images/reception.png'">
                                <div class="prof-info">
                                    <h2 id="prof-name">Doctor Name</h2>
                                    <p id="prof-spec" style="color:var(--primary-blue); font-weight:bold;">Speciality</p>
                                    <div class="prof-meta">
                                        <span><i class="fas fa-graduation-cap"></i> <span id="prof-qual">MBBS</span></span>
                                        <span><i class="fas fa-briefcase"></i> <span id="prof-exp">10 Yrs</span></span>
                                    </div>
                                    <p id="prof-bio" style="font-size:0.9rem; color:#666; margin-top:10px;">
                                        Highly experienced specialist dedicated to patient care.
                                    </p>
                                </div>
                            </div>

                            <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                            <div id="calendar-area">
                                <h4 style="margin-bottom:10px;">Select Appointment Date:</h4>
                                <input type="date" id="appDate" class="input-padded" onchange="generateSlots()">
                                
                                <div id="slots-area" style="display:none; margin-top:20px;">
                                    <h4 style="margin-bottom:10px;">Available Slots:</h4>
                                    <div class="time-slots" id="slots-container">
                                    </div>
                                </div>
                            </div>

                            <button onclick="goBack('step3-profile', 'step2-doctors')" class="btn-text" style="margin-top:20px;">Change Doctor</button>
                        </div>
                    </div>

                    <div id="step4-overview" style="display: none;">
                        <div class="form-header">
                            <h3>Booking Overview</h3>
                            <p>Review details before payment</p>
                        </div>
                        <div style="padding: 30px;">
                            
                            <div class="booking-summary-box">
                                <div class="summary-row">
                                    <span>Patient Name:</span>
                                    <strong id="sum-pname">Name</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Doctor:</span>
                                    <strong id="sum-doc">Dr Name</strong>
                                </div>
                                <div class="summary-row">
                                    <span>Date & Time:</span>
                                    <strong><span id="sum-date"></span> at <span id="sum-time"></span></strong>
                                </div>
                                <div class="summary-row" style="margin-top:15px; padding-top:15px; border-top:1px dashed #ccc;">
                                    <span>Consultation Fee:</span>
                                    <strong style="color:var(--primary-blue); font-size:1.2rem;">₹500.00</strong>
                                </div>
                            </div>

                            <button onclick="processPayment()" class="btn-full" style="background-color: #28a745; margin-top:20px;">
                                Pay & Confirm Booking
                            </button>
                            <button onclick="goBack('step4-overview', 'step3-profile')" class="btn-text">Back</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <div id="final-success" class="full-screen-success" style="display: none;">
        <div class="success-card-centered">
            <div style="font-size: 5rem; color: #28a745; margin-bottom: 20px;">
                <i class="fas fa-check-circle"></i>
            </div>
            <h2 style="color: var(--primary-blue); font-size: 2.2rem;">Booking Confirmed!</h2>
            <p>Your transaction was successful.</p>
            
            <div class="receipt-box">
                <p><strong>Transaction ID:</strong> <span id="txn-id">TXN123456</span></p>
                <div class="token-display">
                    <small>Your Token Number</small>
                    <h1 id="token-display">BLH-402</h1> 
                </div>
                <p style="font-size:0.9rem; color:#555;">Please show this token at the reception.</p>
            </div>

            <a href="index.html" class="btn-primary" style="margin-top: 20px; display: inline-block;">Return to Home</a>
        </div>
    </div>

    <script>
        const API_URL = "http://localhost:5000/api";
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('appDate').min = today;

        let bookingData = {
            patientName: "", phone: "", age: "", symptoms: "", medications: "", history: "",
            doctorName: "", date: "", time: ""
        };
        let selectedDoctorObj = null; // Store doctor details for shift calc

        function goBack(current, target) {
            document.getElementById(current).style.display = 'none';
            document.getElementById(target).style.display = 'block';
        }

        function goToStep2(e) {
            e.preventDefault();
            
            // Capture Data
            bookingData.patientName = document.getElementById('pName').value;
            bookingData.phone = document.getElementById('pPhone').value;
            bookingData.age = document.getElementById('pAge').value;
            bookingData.symptoms = document.getElementById('pSym').value;
            bookingData.medications = document.getElementById('pMeds').value;
            bookingData.history = document.getElementById('pHist').value;
            
            fetchDoctors();
            document.getElementById('step1-form').style.display = 'none';
            document.getElementById('step2-doctors').style.display = 'block';
        }

        // --- 1. DYNAMIC DOCTOR FETCHING ---
        async function fetchDoctors() {
            try {
                const res = await fetch(`${API_URL}/doctors`);
                const doctors = await res.json();
                
                const grid = document.getElementById('dynamicDoctorGrid');
                grid.innerHTML = ""; 
                
                if (doctors.length === 0) {
                    grid.innerHTML = "<p>No doctors available at the moment.</p>";
                    return;
                }

                doctors.forEach(doc => {
                    const card = document.createElement('div');
                    card.className = "doctor-card";
                    card.onclick = () => selectDoctor(doc);
                    
                    const imgSrc = doc.image || 'images/reception.png';
                    const shiftDisplay = (doc.startTime && doc.endTime) 
                        ? `<small style="color:green;">${formatTime(doc.startTime)} - ${formatTime(doc.endTime)}</small>` 
                        : '<small>Standard Shift</small>';

                    card.innerHTML = `
                        <img src="${imgSrc}" class="doc-thumb-large" onerror="this.src='images/reception.png'">
                        <h4>${doc.name}</h4>
                        <p>${doc.specialization}</p>
                        ${shiftDisplay}
                    `;
                    grid.appendChild(card);
                });

            } catch (err) { 
                console.error("Error loading doctors", err);
                document.getElementById('dynamicDoctorGrid').innerHTML = "<p style='color:red;'>Failed to load doctors. Is server running?</p>";
            }
        }

        // --- 2. SELECTION LOGIC ---
        function selectDoctor(doc) {
            selectedDoctorObj = doc; // Store for logic
            bookingData.doctorName = doc.name;

            document.getElementById('prof-name').innerText = doc.name;
            document.getElementById('prof-spec').innerText = doc.specialization;
            document.getElementById('prof-qual').innerText = doc.qualifications;
            document.getElementById('prof-exp').innerText = doc.experience;
            document.getElementById('prof-bio').innerText = doc.bio || "Highly experienced specialist dedicated to patient care.";
            document.getElementById('prof-img').src = doc.image || 'images/reception.png';

            document.getElementById('step2-doctors').style.display = 'none';
            document.getElementById('step3-profile').style.display = 'block';
        }

        // --- 3. DYNAMIC SLOT GENERATION ---
        async function generateSlots() {
            const dateInput = document.getElementById('appDate').value;
            const slotContainer = document.getElementById('slots-container');
            
            if(!dateInput || !selectedDoctorObj) return;
            bookingData.date = dateInput;

            document.getElementById('slots-area').style.display = 'block';
            slotContainer.innerHTML = '<div class="slot-loader">Checking Availability...</div>';

            // 1. Check Doctor Availability Toggle
            if(selectedDoctorObj.isAvailable === false) {
                slotContainer.innerHTML = "<p style='color:red;'>Doctor is unavailable today.</p>";
                return;
            }

            try {
                // 2. Fetch Existing Bookings from DB
                const res = await fetch(`${API_URL}/appointments`);
                const allAppts = await res.json();
                
                // Get list of times that are ALREADY BOOKED for this Doctor + Date
                const bookedSlots = allAppts
                    .filter(a => a.date === dateInput && a.doctor === selectedDoctorObj.name)
                    .map(a => a.timeSlot); // e.g. ["10:00 AM", "10:15 AM"]

                // 3. Calculate Slots based on Doctor's Specific Shift
                // If DB has no time, fallback to 10:00 - 17:00
                const startStr = selectedDoctorObj.startTime || "10:00";
                const endStr = selectedDoctorObj.endTime || "17:00";
                
                // GENERATE
                const slots = createTimeSlots(startStr, endStr, 15); // 15 Minute Interval

                // 4. Render Buttons
                slotContainer.innerHTML = "";
                if(slots.length === 0) {
                    slotContainer.innerHTML = "<p>No slots available.</p>";
                    return;
                }

                slots.forEach(slot => {
                    const btn = document.createElement('button');
                    btn.className = "slot-btn";
                    btn.innerText = slot;

                    // GRAY OUT LOGIC: Check if this slot is in the booked list
                    if(bookedSlots.includes(slot)) {
                        btn.classList.add('booked'); // CSS makes it gray & unclickable
                        btn.disabled = true;
                        btn.title = "Slot Already Booked";
                    } else {
                        // Clickable
                        btn.onclick = () => selectSlot(slot, btn);
                    }
                    slotContainer.appendChild(btn);
                });

            } catch (err) {
                console.error(err);
                slotContainer.innerHTML = "<p style='color:red'>Error loading slots.</p>";
            }
        }

        // --- HELPER: TIME MATH (15 MINS) ---
        function createTimeSlots(startStr, endStr, intervalMins) {
            const slots = [];
            let currentMins = parseTime(startStr);
            let endMins = parseTime(endStr);

            while (currentMins < endMins) {
                slots.push(minutesToTime(currentMins));
                currentMins += intervalMins; // Add 15 mins
            }
            return slots;
        }

        // Convert "14:00" -> 840 minutes
        function parseTime(t) {
            if(!t) return 0;
            const [h, m] = t.split(':').map(Number);
            return h * 60 + m;
        }

        // Convert 840 -> "02:00 PM"
        function minutesToTime(mins) {
            let h = Math.floor(mins / 60);
            let m = mins % 60;
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12; 
            if(h === 0) h = 12; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')} ${ampm}`;
        }

        // Simple formatter for the card display (e.g. 14:00 -> 02:00 PM)
        function formatTime(time24) {
            return minutesToTime(parseTime(time24));
        }

        // --- 4. HANDLE SELECTION & PAYMENT ---
        function selectSlot(time, btnElement) {
            bookingData.time = time;
            
            // Visual Highlight
            document.querySelectorAll('.slot-btn').forEach(b => b.classList.remove('selected'));
            btnElement.classList.add('selected');

            // Fill Overview
            document.getElementById('sum-pname').innerText = bookingData.patientName;
            document.getElementById('sum-doc').innerText = bookingData.doctorName;
            document.getElementById('sum-date').innerText = bookingData.date;
            document.getElementById('sum-time').innerText = bookingData.time;

            // Move to Payment Step
            setTimeout(() => {
                document.getElementById('step3-profile').style.display = 'none';
                document.getElementById('step4-overview').style.display = 'block';
            }, 300);
        }

        async function processPayment() {
            const btn = document.querySelector('#step4-overview .btn-full');
            btn.innerText = "Processing...";
            btn.disabled = true;

            const txnId = "TXN" + Date.now() + Math.floor(Math.random() * 1000);
            
            // Simulate Gateway
            await new Promise(r => setTimeout(r, 2000));

            // --- CHANGED SECTION HERE ---
            // Mapping doctorName -> doctor AND time -> timeSlot
            const payload = {
                ...bookingData,
                doctor: bookingData.doctorName, // Corrected Key for Backend
                timeSlot: bookingData.time,     // Corrected Key for Backend
                type: 'Online',
                paymentStatus: 'Paid',
                fee: '₹500',
                transactionId: txnId
            };
            // ----------------------------

            try {
                const response = await fetch(`${API_URL}/appointments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    document.getElementById('txn-id').innerText = txnId;
                    document.getElementById('token-display').innerText = "BLH-" + Math.floor(Math.random() * 999);
                    
                    document.getElementById('step4-overview').style.display = 'none';
                    document.getElementById('final-success').style.display = 'flex';
                } else {
                    alert("System Error: Could not save booking.");
                }
            } catch (error) {
                alert("Network Error.");
                btn.disabled = false;
                btn.innerText = "Pay Now";
            }
        }
    </script>
</body>
</html>